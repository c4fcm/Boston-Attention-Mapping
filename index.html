<!DOCTYPE html>
<html>
    <head>
        <title>Mapping the (Boston) Globe: A project from the MIT Center for Civic Media</title>
        
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
        <meta charset="utf-8">
            
            
        <script type="text/javascript" charset="utf-8" src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.1/jquery.min.js"></script>
        
        <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?jey=AIzaSyBXG5WcJWdi4vGLGSso0zS2qtCep7NoutE&sensor=false"></script>
        
         <script type="text/javascript" charset="utf-8" src="ui/markerclusterer/markerclusterer.js"></script>
         <!--<script type="text/javascript" src="maplabel.js"></script>-->
        <script src="ui/bootstrap/js/bootstrap.min.js"></script>
        <link href="ui/bootstrap/css/bootstrap.min.css" rel="stylesheet">
        <style type="text/css">
       /* html { 
            background: url(http://www.themapdatabase.com/wp-content/uploads/2009/10/boston_1630_1675.jpg) no-repeat center center fixed; 
            -webkit-background-size: cover;
            -moz-background-size: cover;
            -o-background-size: cover;
            background-size: cover;
        
        }*/
            h1,h4{
                 position:absolute;top:-4px;z-index:1;margin-left:0;background:rgba(100,100,100,0.8);padding:10px;
            }
            h1{
                color:#eee;
            }
            h4{
                margin-top:80px;
                color:#eee;
            }
            form,#navigation{
                position:absolute;
                right: 36px;
                top:7px;
                z-index: 1;
            }
          #navigation{
            font-size: 1.1em;
            color: #EEE;
            width: 250px;
          }
          #navigation a{
            color:#fff;
          }
          .accordion-heading,.collapse{
            background-color:rgba(100,100,100,0.8);
            
          }
          .accordion-heading{
            font-size: 1.4em;
            
          }
          .accordion-group{
            border:0;
          }
          html { height: 100% }
          body { height: 100%; margin: 0; padding: 0; }
          #map_canvas { height: 100% }
          button{
            width:250px;
            margin-bottom:4px;
          }

    </style>

    </head>
    <body>
        <h1><img id="globe-image" src="ui/globe-image.jpeg" width="45px" style="padding-right:10px">Mapping the (Boston) Globe</h1>
        <h4>Loading...</h4>
        <div id="navigation">
           <button type="button" id="article-distribution" class="btn btn-danger btn-large" data-toggle="collapse" data-target="#demo">
              Article Distribution
            </button>
 
            <div id="demo" class="collapse out"> hi </div>
            <button type="button" id="articles-per-capita" class="btn btn-danger btn-large" data-toggle="collapse2" data-target="#demo">
              Articles per Capita
            </button>
 
            <div id="demo" class="collapse2 in"> hi </div>
            <button type="button" id="page1-articles-per-capita" class="btn btn-danger btn-large" data-toggle="collapse3" data-target="#demo">
              Page 1 Articles per Capita
            </button>
 
            <div id="demo" class="collapse3 in"> hi </div>
        </div>
         <!--<form class="form-inline">
            <select>
                <option value="printpublicationdate:20111001..20130100">All (SLOW!)</option>
                
                <option value="printpublicationdate:20120901..20121000">September 2012</option>
                <option value="printpublicationdate:20120801..20120900">August 2012</option>
                <option value="printpublicationdate:20120701..20120800">July 2012</option>
                <option value="printpublicationdate:20120601..20120700">June 2012</option>
                <option value="printpublicationdate:20120501..20120600">May 2012</option>
                 <option value="printpublicationdate:20100409..20100409">-------------</option>
                <option value="printpublicationdate:20120411..20120411">April 11, 2012</option>
                <option value="printpublicationdate:20120410..20120410">April 10, 2012</option>
                <option value="printpublicationdate:20120409..20120409">April 9, 2012</option>
                <option value="printpublicationdate:20100409..20100409">-------------</option>
                <option value="printpublicationdate:20120401..20120500" selected>April 2012</option>
                <option value="printpublicationdate:20120301..20120400">March 2012</option>
                <option value="printpublicationdate:20120201..20120300">February 2012</option>
                <option value="printpublicationdate:20120101..20120200">January 2012</option>
                <option value="printpublicationdate:20111201..20130100">December 2011</option>
                <option value="printpublicationdate:20111101..20111200">November 2011</option>
                <option value="printpublicationdate:20111001..20111100">October 2011</option>
                

            </select>
        </form>-->
        <div id="map_canvas" style="width:100%; height:100%"></div>
       
    </body>
    <script type="text/javascript"> 
            $(document).ready(function() {
                $('#article-distribution').click(function(){
                    showArticleDistribution();
                    hidePolygons();

                });
                $('#articles-per-capita').click(function(){

                    clearMarkers();
                    showArticlesPerCapita();
                    
                });



                var popoverImage = '<img src="ui/globe-image.jpeg" />';
                $('#globe-image').popover({ trigger: 'hover', placement : 'bottom', title: '<b>What is the Boston Globe?</b>', content: popoverImage + '<br/><br/>An American daily newspaper based in Boston, MA, USA. The Boston Globe was founded in 1872, has won 21 Pulitzer Prizes, and has a circulation between 220,000 - 370,000. (Wikipedia)' });
               
                window.markers = [];
                var stylesArray = [
                                      {
                                        "featureType": "road",
                                        "stylers": [
                                          { "visibility": "off" }
                                        ]
                                      },{
                                        "featureType": "poi",
                                        "stylers": [
                                          { "visibility": "off" }
                                        ]
                                      },{
                                        "featureType": "water",
                                        "stylers": [
                                          { "visibility": "simplified" }
                                        ]
                                      },{
                                        "featureType": "landscape",
                                        "stylers": [
                                          { "visibility": "on" },
                                          { "color": "#fdfdfd" }
                                        ]
                                      },{
                                        "featureType": "transit",
                                        "stylers": [
                                          { "visibility": "off" }
                                        ]
                                      },{
                                      },{
                                        "featureType": "landscape",
                                        "stylers": [
                                          { "visibility": "on" },
                                          { "color": "#faf9fb"}
                                          //"color": "#666666" }
                                        ]
                                      },{
                                        "featureType": "water",
                                        "stylers": [
                                          { "visibility": "simplified" },
                                          { "color": "#9cf0f4" }
                                        ]
                                      },
                                    ];
               
                drawMap();
                
               showArticleDistribution();

                //this loads town polygons in background
                loadPolygons();
                
                 var image = 'ui/news_icon_transparent.png';


                

                function drawMap(){
                    var mapOptions = {
                      center: new google.maps.LatLng(42.358056, -71.063611),
                      zoom: 11,
                      mapTypeId: google.maps.MapTypeId.ROADMAP,
                      styles:stylesArray,
                      disableDefaultUI: true,
                      zoomControl: true,
                      zoomControlOptions: {
                        style: google.maps.ZoomControlStyle.LARGE,
                        position: google.maps.ControlPosition.RIGHT_TOP
                      }
                     
                    };
                    var articlesWithGeoData = 0;

                    window.map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);
                   
                   
                   
                   
                   
                }
                function clearMarkers() {
                  for (var i = 0; i < window.markers.length; i++ ) {
                    window.markers[i].setMap(null);
                  }
                  window.markerCluster.clearMarkers();
                }

                function addMarker(article,infowindow) {
                    
                    var point = new google.maps.LatLng(article.latitude[0], article.longitude[0]); 
                    var marker = new google.maps.Marker({
                        position:point,
                        map: window.map,
                        title: article.headline[0],
                        icon:image
                    }); 
                    window.markers.push(marker);
                    google.maps.event.addListener(marker, 'mouseover', function() {
                      infowindow.open(window.map,marker);
                    });
                     google.maps.event.addListener(marker, 'mouseout', function() {
                      infowindow.close();
                    });
                };
                function showArticleDistribution(){
                    var jqxhr =  $.getJSON('couchdb/boston-globe-articles/_design/allArticles/_view/allArticles', function() {
                  
                      })
                       .success(function(json) { 
                          var articlesWithGeoData = 0;
                        
                           if (json.rows.length > 0) {
                                for (i=0; i<json.rows.length; i++) {
                                    var article = json.rows[i].value;
                                      
                                        var contentString = '<div id="content">';
                                       if (article.headline[0]){
                                            contentString=contentString+'<h3 id="firstHeading" class="firstHeading">'+
                                                article.headline[0] 
                                            +'</h3>';
                                        }
                                        contentString = contentString+'<div id="bodyContent">'+
                                            '<p>'+ article.summary[0] +'</p>';
                                        if (article.printsection[0]){
                                          contentString =  contentString +'<p><b>'+article.printsection[0] +' section '  +'</b></p>';
                                        }
                                        if (article.printpagenumber[0]){
                                          contentString  = contentString + '<p><b>Page '+ article.printpagenumber[0] +'</b></p>';
                                        }
                                        
                                            '</div>'+
                                            '</div>';
                                            
                                           
                                          
                                           
                                        var infowindow = new google.maps.InfoWindow({
                                            content: $(contentString).html()
                                        });
                                        addMarker(article,infowindow); 
                                        
                                    
                                }
                                window.markerCluster = new MarkerClusterer(window.map, window.markers,{gridSize: 50,maxZoom:11});
                                $('h4').text(json.rows.length + " total articles retrieved");
                            }
                            else{
                                $('h4').text('No data for that time period');
                            }
                        })
                    .error(function(data) { console.log(data) })
                    .complete(function() { console.log("Loaded all articles") }); 
                }
                function showArticlesPerCapita(){

                    var jqxhr =  $.getJSON('couchdb/boston-globe-articles/_design/cities/_view/cityCount?group=true', function() {
                  
                      })
                       .success(function(json) { 
                          
                        
                           if (json.rows.length > 0) 
                           {
                                var maxValue = 0;
                                var minValue = 0;
                                for (i=0; i<json.rows.length; i++) {
                                    var town = json.rows[i].key[0];
                                    
                                    if (town != null && town.length > 0 && town != "Boston" && town != "Washington" && window.townPolygons[town.toUpperCase()] != null){
                                      var articleCount = json.rows[i].value;
                                      
                                      if (maxValue == 0 && minValue == 0){
                                        maxValue =articleCount;
                                        minValue =articleCount;
                                      }
                                      if (articleCount>maxValue){
                                        maxValue =articleCount;
                                       
                                      } else if(articleCount<minValue){
                                        minValue=articleCount;
                                      }
                                    }
                                }
                                var diff = maxValue - minValue;
                                var step = diff/4;
                                for (i=0; i<json.rows.length; i++) {
                                    var town = json.rows[i].key[0];
                                    if (town != null && town.length > 0){
                                      var articleCount = json.rows[i].value;
                                      
                                      var townPolygon = window.townPolygons[town.toUpperCase()];
                                      //handle case where multipolys
                                      if (townPolygon instanceof Array){
                                          
                                          for (var j=0;j<townPolygon.length;j++){
                                            var poly = townPolygon[j];
                                            if (poly != null) {
                                              setPolygonOpacity(articleCount,minValue,maxValue,step,poly);
                                            }
                                          }
                                      }
                                      else if (townPolygon != null) {
                                        setPolygonOpacity(articleCount,minValue,maxValue,step,townPolygon);
                                      }
                                    }   
                                }
                                
                                $('h4').text("Articles per capita - Heat Map");
                            }
                           
                        })
                    .error(function(data) { console.log(data) })
                    .complete(function() { console.log("Loaded all city counts") }); 
                    

                }
                function setPolygonOpacity(articleCount,minValue,maxValue,step,townPolygon){
                  var opacity = 0;
                  if (articleCount >= minValue && articleCount <= minValue + step)
                    opacity=0.2;
                  else if (articleCount > minValue + step && articleCount <= minValue + step * 2)
                    opacity=0.4;
                  else if (articleCount > minValue + step * 2 && articleCount <= minValue + step * 3)
                    opacity=0.6;
                  else if (articleCount > minValue + step * 3)
                    opacity=0.8;
                 
                  townPolygon.setOptions({fillOpacity: opacity,strokeWeight:1,strokeOpacity:0.8, strokeColor: "#a65c1c"});
                  console.log("max is " + maxValue + " min is  "+ minValue)
                  console.log("town is " + townPolygon.townName +  " has articles " + articleCount)
                  console.log("opacity is " + opacity)
                }
                function hidePolygons(){
                    for (var town in window.townPolygons) {
                      var townPolygon = window.townPolygons[town];
                  
                      townPolygon.setOptions({fillOpacity: 0,strokeWeight:1,strokeOpacity:0.8,strokeColor: "#CCCCCC"});
                    }
                }
                function loadPolygon(townCoordinates,townName){
                  var townBoundaryArray = [];
                  for (var j=0; j<townCoordinates.length;j++){
                    var longitude = townCoordinates[j][0];
                    var latitude = townCoordinates[j][1];
                    var latlong = new google.maps.LatLng(latitude, longitude);
                    townBoundaryArray[j] = latlong;
                    
                  }
                  

                  var townPolygon = new google.maps.Polygon({
                    paths: townBoundaryArray,
                    strokeColor: "#CCCCCC",
                    //strokeColor: "#a65c1c",
                    strokeOpacity: 0.8,
                    strokeWeight: 1,
                    fillColor: '#ffba2b',
                    //fillColor: '#FFFFFF',
                    fillOpacity: 0 
                  });
                  
                  townPolygon.setMap(window.map);
                  townPolygon.set("townName",townName);
                 
                  
                  google.maps.event.addListener(townPolygon, 'click', function(event) {
                        
                          polywindow.setContent(this.get('townName'));
                          polywindow.setPosition(event.latLng);

                          polywindow.open(window.map);
                  });
                  return townPolygon;

                }
                function loadPolygons(){
                  var jqxhr =  $.getJSON('data/shapefiles/townsShapeFiles/MATowns.json', function() {
                      
                    })
                    .success(function(data) {   
                      window.townPolygons = {};
                      var polywindow = new google.maps.InfoWindow();
                      for (var i = 0; i < data.features.length; i++) {
                        var town = data.features[i];
                        var townName = town.properties.TOWN;
                        
                        var townPolygon = null;
                         //Handle multipolygons - what a pain!
                        if (town.geometry.type == "MultiPolygon"){
                           
                            var townPolygonArray = [];
                           
                           for (var j=0;j<town.geometry.coordinates.length;j++){
                              townPolygon = loadPolygon(town.geometry.coordinates[j][0], townName);
                              townPolygonArray[j] =townPolygon;
                           }
                            window.townPolygons[townName]=townPolygonArray;
                        } else {
                            townPolygon =loadPolygon(town.geometry.coordinates[0], townName);
                            window.townPolygons[townName]=townPolygon;
                        }
                      }
                    })
                    .error(function(data) { console.log(data) })
                    .complete(function() { console.log("Loaded MA Towns from GEOJSON...") });
                }

            });
        </script>
        <script type="text/javascript">
        /* 
            Extension to Google Maps to get center of polygon 
            From here: http://code.google.com/p/google-maps-extensions/source/browse/google.maps.Polygon.getBounds.js
        
          if (!google.maps.Polygon.prototype.getBounds) {

                  google.maps.Polygon.prototype.getBounds = function(latLng) {

                          var bounds = new google.maps.LatLngBounds();
                          var paths = this.getPaths();
                          var path;
                          
                          for (var p = 0; p < paths.getLength(); p++) {
                                  path = paths.getAt(p);
                                  for (var i = 0; i < path.getLength(); i++) {
                                          bounds.extend(path.getAt(i));
                                  }
                          }

                          return bounds;
                  }

          }*/
        </script>
</html>