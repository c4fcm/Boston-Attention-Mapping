<!DOCTYPE html>
<html>
    <head>
        <title>Mapping the (Boston) Globe: A project from the MIT Center for Civic Media</title>
        
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
        <meta charset="utf-8">
            
            
        <script type="text/javascript" charset="utf-8" src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.1/jquery.min.js"></script>
        
        <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?jey=AIzaSyBXG5WcJWdi4vGLGSso0zS2qtCep7NoutE&sensor=false"></script>
        
         <script type="text/javascript" charset="utf-8" src="ui/markerclusterer/markerclusterer.js"></script>
         <!--<script type="text/javascript" src="maplabel.js"></script>-->
        <script src="ui/bootstrap/js/bootstrap.min.js"></script>
        <link href="ui/bootstrap/css/bootstrap.min.css" rel="stylesheet">
        <style type="text/css">
       /* html { 
            background: url(http://www.themapdatabase.com/wp-content/uploads/2009/10/boston_1630_1675.jpg) no-repeat center center fixed; 
            -webkit-background-size: cover;
            -moz-background-size: cover;
            -o-background-size: cover;
            background-size: cover;
        
        }*/
            #h1-title,#about{
                 position:absolute;top:-4px;z-index:1;margin-left:0;background:rgba(100,100,100,0.8);padding:10px;
            }
            #h1-title{
                color:#eee;
                width:535px;
                display:none;
            }
            
            #about{
              width: 535px;
              top: 62px;
              color: #EEE;
              display:none;
            }
            #about a{
              color:#fff;
            }
            
            form,#navigation{
                position:absolute;
                right: 36px;
                top:7px;
                z-index: 1;
            }
          #navigation{
            font-size: 1.1em;
            color: #EEE;
            width: 250px;
          }
          #navigation a{
            color:#fff;
          }
          #navigation button{
            text-align: left;
          }
          .accordion-heading,.collapse{
            background-color:rgba(100,100,100,0.8);
            
          }
          .accordion-heading{
            font-size: 1.4em;
            
          }
          .accordion-group{
            border:0;
          }
          html { height: 100% }
          body { height: 100%; margin: 0; padding: 0; }
          #map_canvas { height: 100% }
          button{
            width:250px;
            margin-bottom:4px;
          }
          #headlines{
           position: absolute;
            width: 230px;
            background-color: rgba(100, 100, 100, 0.8);
            border-radius: 4px;
            top: 228px;
            right: 35px;
            color: white;
            padding: 10px;
            max-height:500px;
            
            
            -webkit-box-shadow: inset 2px 2px 2px 2px rgba(0, 0, 0, 0.2);
            box-shadow: inset 2px 2px 2px 2px rgba(0, 0, 0, 0.2);

          }
          .results h4{
            text-align:center;
          }
          .stripe{
            background-color: rgba(255, 255, 255, 0.1);
            padding-left: 3px;
          }
          #headlines a{
            color:#fff;
          }
          #headlines p{
            border-top:1px solid #eee;
            margin:0;
            font-size:0.9em;
          }
          #headlines .page1{
            font-size:1.2em;
            font-weight:bold;
          }
          .scrolling{
            overflow-x:hidden;
            overflow-y:scroll;
          }
          .active{
            font-weight: bold;
          }
          #loading-screen{
            z-index: 2;
            top: 0;
            background-color: rgba(0, 0, 0, 0.6);
            position: absolute;
            width: 100%;
            height: 100%;
          }
          #loading-screen-description{
            border: 1px solid black;
            text-align: center;
            padding: 20px;
            -webkit-border-radius: 4px;
            border-radius: 4px;
            background-color: white;
            -webkit-box-shadow: 2px 2px 2px 2px rgba(0, 0, 0, 0.3);
            box-shadow: 2px 2px 2px 2px rgba(0, 0, 0, 0.3);
            width: 40%;
            position: relative;
            margin: 5% auto;
          }
    </style>

    </head>
    <body>
        <h1 id="h1-title"><img id="globe-image" src="ui/globe-image.jpeg" width="45px" style="padding-right:10px">Mapping the Globe</i></h1>
        
        <h4 id="about">Mapping the Globe uses geocoded data from the Boston Globe API, geographic data from MassGIS and the Boston Redevelopment Authority, and census data from the US census and the American Community Survey. The story data is from the time period between November 2011 to the present. <br/><br/>Please refer questions to <a href="mailto:dignazio@mit.edu">Catherine D'Ignazio</a> and <a href="mailto:ethanz@media.mit.edu">Ethan Zuckerman</a> at <a href="http://civic.mit.edu">the Center for Civic Media at MIT</a>.</h4>
        
        <div id="navigation">
           <button type="button" id="article-distribution" class="btn btn-danger btn-large active">
              Story Distribution
            </button>
 
            
            <button type="button" id="articles-per-capita" class="btn btn-danger btn-large">
              Stories per Capita
            </button>
            
            <button type="button" id="page1-distribution" class="btn btn-danger" style="margin-top:8px">
              Page 1 Distribution 
            </button>
            <button type="button" id="page1-per-capita" class="btn btn-danger">
              Page 1 per Capita
            </button>
            
            <button type="button" id="today-distribution" class="btn btn-danger" style="margin-top:8px">
              Today's Distribution
            </button>
            <button type="button" id="today-per-capita" class="btn btn-danger">
              Today's per Capita
            </button>
            
        </div>
        
        <div id="map_canvas" style="width:100%; height:100%"></div>
        <div id="loading-screen">
            <div id="loading-screen-description">
                <h1>Mapping the Globe</h1>
                <h3>Nov 2011 - Present</h3>
                <h4 style="text-align:justify">Mapping the Globe is a set of interactive visualizations and maps that help us understand where the Boston Globe directs its attention. Media attention matters â€“ in quantity and quality. It helps determine what we talk about as a public and how we talk about it. Mapping the Globe tracks where the paper's attention goes and what that attention looks like across different regional geographies in combination with diverse data sets like population, crime and income. <br/><br/>By <a href="mailto:dignazio@mit.edu">Catherine D'Ignazio</a> and <a href="mailto:ethanz@media.mit.edu">Ethan Zuckerman</a> at <a href="http://civic.mit.edu">the Center for Civic Media at MIT</a>.</h4>
                <p><img src="http://civic.mit.edu/sites/civic.mit.edu/themes/c4cmtheme/logo.png" style="margin-right: 50px;
height: 100px;"><img src="http://c.o0bg.com/rw/SysConfig/WebPortal/BostonGlobe/Framework/images/logo-
bg.png" style="padding-top: 58px;height: 35px;"></p>
                <button type="button" id="enter-button" class="btn btn-danger btn-large active">
                  Enter
                </button>
            </div>
        </div>
        <div id="headlines" class="results"><h4 style="text-align: center"><img src="ui/loading.gif" style="padding-right:5px">Loading...</h4></div>
    </body>
    <script type="text/javascript"> 
            $(document).ready(function() {

               if (location.href.indexOf("file:///") >= 0){
                  window.couchURL = 'http://127.0.0.1:5984/';
                } else{
                  window.couchURL = 'couchdb/';
                }

                $("#enter-button").click(function(){
                    $("#loading-screen").fadeOut('slow');
                    $("#h1-title").fadeIn('slow');
                });
                $("h1").mouseover(function(){$('#about').show()});
                $("h1").mouseout(function(){$('#about').hide()});
                $('#article-distribution').click(function(){
                    
                    
                    switchFromPerCapitaToDistribution();
                    showLoading();
                    $(this).addClass('active');
                    showArticleDistribution("all");

                });
                $('#articles-per-capita').click(function(){
                    switchFromDistributionToPerCapita();
                    showLoading();
                    showArticlesPerCapita("all");
                    $(this).addClass('active');
                    
                });
                $('#page1-distribution').click(function(){
                    
                    
                    switchFromPerCapitaToDistribution();
                    showLoading();
                    showArticleDistribution("page1");
                    $(this).addClass('active');

                });
                $('#page1-per-capita').click(function(){
                    switchFromDistributionToPerCapita();
                    showLoading();
                    showArticlesPerCapita("page1");
                    $(this).addClass('active');
                    
                });
                $('#today-distribution').click(function(){
                    switchFromPerCapitaToDistribution();
                    showLoading();
                    showArticleDistribution("today");

                    $(this).addClass('active');

                });
                $('#today-per-capita').click(function(){
                    switchFromDistributionToPerCapita();
                    showLoading();
                    showArticlesPerCapita("today");
                    $(this).addClass('active');
                    
                });
               
                window.markers = [];
                var stylesArray = [
                                      {
                                        "featureType": "road",
                                        "stylers": [
                                          { "visibility": "off" }
                                        ]
                                      },{
                                        "featureType": "poi",
                                        "stylers": [
                                          { "visibility": "off" }
                                        ]
                                      },{
                                        "featureType": "water",
                                        "stylers": [
                                          { "visibility": "simplified" }
                                        ]
                                      },{
                                        "featureType": "landscape",
                                        "stylers": [
                                          { "visibility": "on" },
                                          { "color": "#fdfdfd" }
                                        ]
                                      },{
                                        "featureType": "transit",
                                        "stylers": [
                                          { "visibility": "off" }
                                        ]
                                      },{
                                      },{
                                        "featureType": "landscape",
                                        "stylers": [
                                          { "visibility": "on" },
                                          { "color": "#faf9fb"}
                                          //"color": "#666666" }
                                        ]
                                      },{
                                        "featureType": "water",
                                        "stylers": [
                                          { "visibility": "simplified" },
                                          { "color": "#9cf0f4" }
                                        ]
                                      },
                                    ];
               
                drawMap();
                loadMetadata();
                showArticleDistribution("all");
                loadTownPolygons();
                loadNeighborhoodPolygons();
                
                 var image = 'ui/news_icon_transparent.png';
                function showLoading(){
                  $('.results').html('<h4 style="text-align: center"><img src="ui/loading.gif" style="padding-right:5px">Loading...</h4>');
                }
                function switchFromPerCapitaToDistribution(){
                  hidePolygons();
                  $('#headlines').removeClass("scrolling");
                  $('#headlines').empty();
                   $('button').removeClass('active');
                }
                function switchFromDistributionToPerCapita(){
                     $('button').removeClass('active');
                     hideMarkers();
                }
                 function log10(num){
                    return Math.log(num) / Math.LN10;
                 }
                function loadMetadata(){
                    var jqxhr =  $.getJSON(window.couchURL + 'boston-globe-articles/_design/globe/_view/metadata', function() {
                            console.log('Loading metadata document...')
                        })
                       .success(function(json) {  
                             window.metadata = json.rows[0].key;
                             
                          })
                      .error(function(data) { console.log(data) })
                      .complete(function() { console.log("Loaded metadata") });

                }
                function drawMap(){
                    var mapOptions = {
                      center: new google.maps.LatLng(42.358056, -71.063611),
                      zoom: 11,
                      mapTypeId: google.maps.MapTypeId.ROADMAP,
                      styles:stylesArray,
                      disableDefaultUI: true,
                      zoomControl: true,
                      zoomControlOptions: {
                        style: google.maps.ZoomControlStyle.LARGE,
                        position: google.maps.ControlPosition.RIGHT_TOP
                      }
                     
                    };
                    var articlesWithGeoData = 0;

                    window.map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);
       
                }
               
                function showMarkers() {
                    for (var i = 0; i < window.markers.length; i++ ) {
                      window.markers[i].setVisible(true);
                    }
                     window.markerCluster = new MarkerClusterer(window.map, window.markers,{gridSize: 50,maxZoom:11});
                }
                function hideMarkers() {
                    for (var i = 0; i < window.markers.length; i++ ) {
                      window.markers[i].setVisible(false);
                    }
                    if (window.markerCluster)
                      window.markerCluster.clearMarkers();
  
                    window.markerCluster = null;
                }
                function clearMarkers() {
                  for (var i = 0; i < window.markers.length; i++ ) {
                    window.markers[i].setMap(null);
                  }
                  if (window.markerCluster)
                    window.markerCluster.clearMarkers();
                  window.markers = null;
                  window.markerCluster = null;
                }

                function addMarker(article,infowindow) {

                    var point = new google.maps.LatLng(article.latitude[0], article.longitude[0]); 
                    var marker = new google.maps.Marker({
                        position:point,
                        map: window.map,
                        title: article.headline[0],
                        icon:image
                    }); 
                    window.markers.push(marker);
                    google.maps.event.addListener(marker, 'mouseover', function() {
                      infowindow.open(window.map,marker);
                    });
                     google.maps.event.addListener(marker, 'mouseout', function() {
                      infowindow.close();
                    });
                };
                function showArticleDistribution(whichArticles){

                  
                  var view = "all_articles";
                  if (whichArticles == "page1")
                    view = 'all_articles_page1?key="1"';
                  else if (whichArticles == "today")
                    view = 'all_articles_by_date?key="20121021"';
                  console.log(view)
                  if (whichArticles != window.currentView) {
                      window.currentView= whichArticles;
                      var jqxhr =  $.getJSON(window.couchURL + 'boston-globe-articles/_design/globe/_view/' + view, function() {
                    
                        })
                         .success(function(json) { 
                           
                            if (window.markers != null && window.markers.length > 0)
                                clearMarkers();
                              window.markers = [];
                             if (json.rows.length > 0) {
                                  for (i=0; i<json.rows.length; i++) {
                                      var article = json.rows[i].value;
                                        
                                          var metaDataString = "<b>";
                                          if (article.printpublicationdate[0])
                                              
                                              metaDataString+=  article.printpublicationdate[0].substring(4,6) +"/"+ article.printpublicationdate[0].substring(6,8) + "/"+ article.printpublicationdate[0].substring(0,4) +". ";

                                          if (article.printsection[0]){
                                             metaDataString+=article.printsection[0] +' Section. ';
                                          }
                                          if (article.printpagenumber[0]){
                                            metaDataString+= 'Page '+article.printpagenumber[0] +'. ';
                                          }
                                          metaDataString +="</b>";
                                          var contentString = '<div id="content">';
                                         if (article.headline[0]){
                                              contentString+='<h3 id="firstHeading" class="firstHeading">'+
                                                  article.headline[0] 
                                              +'</h3>';
                                          }
                                          contentString += '<div id="bodyContent">'+'<p>'+ metaDataString + article.summary[0] +'</p>';
                                              '</div>'+
                                              '</div>';
            
                                          var infowindow = new google.maps.InfoWindow({
                                              content: $(contentString).html()
                                          });
                                          addMarker(article,infowindow); 
                                          
                                      
                                  }
                                  
                                  
                                  $('.results').html('<h4>'+addCommas(json.rows.length) + " total stories retrieved from November 2011 to the present.</h4>");
                              }
                              else{
                                  $('.results').html('<h4>No data for that time period</h4>');
                              }
                          })
                      .error(function(data) { console.log(data) })
                      .complete(function() { 
                        showMarkers();
                        console.log("Loaded all stories") 
                      }); 
                  } else {
                    showMarkers();
                  }
                }
                function showArticlesPerCapita(whichArticles){
                  var view = "city_count";
                  if (whichArticles == "page1")
                    view = "city_count_page_1";
                  else if (whichArticles == "today")
                    view = "city_count_today";

                  

                    window.currentView= whichArticles;
                    var jqxhr =  $.getJSON(window.couchURL + 'boston-globe-articles/_design/globe/_view/'+view+'?group=true', function() {
                  
                      })
                       .success(function(json) { 
                          
                        
                           if (json.rows.length > 0) 
                           {
                                var maxValue = 0;
                                var minValue = 0;
                                
                                for (i=0; i<json.rows.length; i++) {
                                    var town = json.rows[i].key[0];
                                    var neighborhood = json.rows[i].key[1];
                                    var isNeighborhood = false;
                                    //Todo - Globe has bad geodata for towns with names like Georgetown & Berlin, filter for now
                                    if (town != null && town.length > 0 )
                                    {
                                      
                                      //Store # articles for later display
                                      if (town != "Boston" && window.townPolygons[town.toUpperCase()] != null)  
                                      {  window.townPolygons[town.toUpperCase()].articleCount =json.rows[i].value;
                                        
                                      }
                                      else if (town == "Boston" && neighborhood.length > 0){
                                          
                                            window.neighborhoodPolygons[neighborhood].articleCount =json.rows[i].value;
                                            isNeighborhood = true;
                                        
                                      }
                                      else{
                                        continue;
                                      }

                                      var articleCount = json.rows[i].value;
                                      var metadata = isNeighborhood? window.metadata.neighborhoodmetadata[neighborhood] : window.metadata.citymetadata[town];
                                      //TODO - this means town names are not standardized - go back and do this later
                                      //Filtering out crazy neighborhoods that throw off max & mins
                                      if(metadata != null && neighborhood != "Leather District" && neighborhood != "South Boston Waterfront" && neighborhood != "Bay Village" && town != "Berlin" && town != "Georgetown" && town != "Rochester"){
                                        var population = isNeighborhood ? metadata['neighborhood_population_2010'] : metadata['city_population_2010'];
                                        var perCapita = articleCount/population;

                                        if (maxValue == 0 && minValue == 0){
                                          maxValue =perCapita;
                                          minValue =perCapita;
                                        }
                                        if (perCapita>maxValue){
                                          maxValue =perCapita;
                                         
                                        } else if(perCapita<minValue){
                                          minValue=perCapita;
                                        }
                                      }
                                    }
                                }
                                var diff = maxValue - minValue;
                                var step = diff/8;
                                for (i=0; i<json.rows.length; i++) {
                                    var town = json.rows[i].key[0];
                                    var neighborhood = json.rows[i].key[1];

                                    var isNeighborhood = (town == "Boston" && neighborhood.length > 0);

                                    if ((town != null && town.length > 0 && town != "Berlin" && town != "Georgetown" && town != "Rochester") || (isNeighborhood))
                                    {

                                      var articleCount = json.rows[i].value;
                                      var metadata = isNeighborhood? window.metadata.neighborhoodmetadata[neighborhood] : window.metadata.citymetadata[town];
                                      
                                      //TODO - this means town names are not standardized - go back and do this later
                                      if (metadata !=null){
                                        var population = isNeighborhood ? metadata['neighborhood_population_2010'] : metadata['city_population_2010'];
                                        var perCapita = articleCount/population;
                                        
                                        var geoPolygon = isNeighborhood ? window.neighborhoodPolygons[neighborhood] : window.townPolygons[town.toUpperCase()];
                                        //handle case where multipolys
                                        if (geoPolygon instanceof Array){
                                            
                                            for (var j=0;j<geoPolygon.length;j++){
                                              var poly = geoPolygon[j];
                                              if (poly != null) {
                                                setPolygonOpacity(perCapita,minValue,maxValue,step,poly);
                                              }
                                            }
                                        }
                                        else if (geoPolygon != null) {
                                          setPolygonOpacity(perCapita,minValue,maxValue,step,geoPolygon);
                                        }
                                      }
                                      
                                    }  
                                    if (town == "Berlin" || town == "Georgetown" || town == "Rochester"){
                                        var geoPolygon = isNeighborhood ? window.neighborhoodPolygons[neighborhood] : window.townPolygons[town.toUpperCase()];
                                        setPolygonGrey(geoPolygon);

                                    } 
                                    
                                }
                            }
                           
                        })
                    .error(function(data) { console.log(data) })
                    .complete(function() { 
                      $('.results').html('<h4>Headlines</h4>');
                      console.log("Loaded shapes") 
                    }); 
                    

                }
                function setPolygonGrey(townPolygon){
                  townPolygon.setOptions({fillOpacity: 0.7,strokeWeight:1,strokeOpacity:0.8, strokeColor: "#a65c1c", fillColor:'#CCCCCC'});
                }
                function setPolygonOpacity(articleCount,minValue,maxValue,step,townPolygon){
                  var opacity = 0;
                  if (articleCount >= minValue && articleCount <= minValue + step){
                    opacity=0.2;
                    fillColor = "#ffba2b";
                  }
                  else if (articleCount > minValue + step && articleCount <= minValue + step * 2){
                    opacity=0.5;
                    fillColor = "#ffba2b";
                  }
                  else if (articleCount > minValue + step * 2 && articleCount <= minValue + step * 3){
                    opacity=0.8;
                    fillColor = "#ffba2b";
                  }
                  else if (articleCount > minValue + step * 3 && articleCount <= minValue + step * 4){
                    opacity=1.0;
                    fillColor = "#ffba2b";
                  }
                  else if (articleCount > minValue + step * 4 && articleCount <= minValue + step * 5){
                    opacity=0.8;
                    fillColor = "#a63d03";
                  }
                  else if (articleCount > minValue + step * 5 && articleCount <= minValue + step * 6){
                    opacity=1.0;
                    fillColor = "#a63d03";
                  }
                  else if (articleCount > minValue + step * 6 && articleCount <= minValue + step * 7){
                    opacity=0.8;
                    fillColor = "#FF502B";
                  }
                  else {
                    opacity = 1.0;
                    fillColor = "#FF502B";
                  }
                 
                 
                  townPolygon.setOptions({fillOpacity: opacity,strokeWeight:1,strokeOpacity:0.8, strokeColor: "#a65c1c", fillColor:fillColor});
                 
                }
                function hidePolygons(){
                    for (var town in window.townPolygons) {
                      var geoPolygon = window.townPolygons[town];
                      if (geoPolygon instanceof Array){
                                            
                          for (var j=0;j<geoPolygon.length;j++){
                            var poly = geoPolygon[j];
                            if (poly != null) {
                              poly.setOptions({fillOpacity: 0,strokeWeight:1,strokeOpacity:0.8,strokeColor: "#CCCCCC"});
                            }
                          }
                      }
                      else{
                        geoPolygon.setOptions({fillOpacity: 0,strokeWeight:1,strokeOpacity:0.8,strokeColor: "#CCCCCC"});
                      }
                    }
                    for (var neighborhood in window.neighborhoodPolygons) {
                      var geoPolygon = window.neighborhoodPolygons[neighborhood];
                      if (geoPolygon instanceof Array){
                                            
                          for (var j=0;j<geoPolygon.length;j++){
                            var poly = geoPolygon[j];
                            if (poly != null) {
                              poly.setOptions({fillOpacity: 0,strokeWeight:1,strokeOpacity:0.8,strokeColor: "#CCCCCC"});
                            }
                          }
                      }
                      else{
                        geoPolygon.setOptions({fillOpacity: 0,strokeWeight:1,strokeOpacity:0.8,strokeColor: "#CCCCCC"});
                      }
                    }
                }
                function loadPolygon(townCoordinates,townName,isNeighborhood){

                  var townBoundaryArray = [];
                  for (var j=0; j<townCoordinates.length;j++){
                    var longitude = townCoordinates[j][0];
                    var latitude = townCoordinates[j][1];
                    var latlong = new google.maps.LatLng(latitude, longitude);
                    townBoundaryArray[j] = latlong;
                    
                  }
                  

                  var townPolygon = new google.maps.Polygon({
                    paths: townBoundaryArray,
                    strokeColor: "#CCCCCC",
                    //strokeColor: "#a65c1c",
                    strokeOpacity: 0.8,
                    strokeWeight: 1,
                    fillColor: '#ffba2b',
                    //fillColor: '#FFFFFF',
                    fillOpacity: 0 
                  });
                  
                  townPolygon.setMap(window.map);
                  townPolygon.set("townName",townName);
                 
                  var polywindow = new google.maps.InfoWindow();
                  google.maps.event.addListener(townPolygon, 'click', function(event) {
                        $('#headlines').empty();
                        
                        var name = this.get('townName');
                        
                        name = name.toProperCase();
                        var metadata = isNeighborhood ? window.metadata.neighborhoodmetadata[name] : window.metadata.citymetadata[name];

                        var population = isNeighborhood ? metadata['neighborhood_population_2010'] : metadata['city_population_2010'];
                        var articleCount = isNeighborhood ? window.neighborhoodPolygons[name].articleCount : window.townPolygons[name.toUpperCase()].articleCount;
                        if (articleCount == null)
                            articleCount = 0;
                        var perCapita = articleCount / population;


                        
                        $('#headlines').append("<h4>"+name + " Headlines" + ((window.currentView == "page1") ? "<br/>Page 1" : "") + ((window.currentView == "today") ? "<br/>Today" : "" )+ "</h4>");
                        polywindow.setPosition(event.latLng);

                        
                        





                      //Load words into popup window
                      var jqxhr =  $.getJSON(window.couchURL + 'boston-globe-articles/_design/nltk/_view/place_frequency?startkey=["'+ name +'"]&endkey=["'+name+'",{}]', function() {
                
                        })
                       .success(function(json) {  
                              var words = json.rows[0].value.freqdist;
                              var placeWords = '<div style="line-height:'+ words[1][1] +'em">';
                              for (i=0; i<words.length; i++) {

                                var word = words[i][0];
                                if (word != name){
                                  
                                  var fontSize = words[i][1] + 1;
                                  
                                  placeWords += " <span class='label' style='margin-right:5px;margin-bottom:5px;font-size:"+Math.max(fontSize,0.75)+"em'>"+ word+"</span>";
                                }
                                
                             }
                             placeWords += "</div>";
                             polywindow.setContent('<h3 id="firstHeading" class="firstHeading">'+name+ "</h3>" + "<br/>"+
                                                                  
                                                                  //addCommas(articleCount) + " stories" + "<br/>"+
                                                                  //addCommas(population) + " Residents"+"<br/>"+
                                                                  //"Stories per capita for this time period: " + perCapita.toFixed(5) +
                                                                  //"<h4>Words associated with "+name+":</h4>"+
                                                                  placeWords);
                        

                              polywindow.open(window.map);
                             
                          })
                      .error(function(data) { console.log(data) })
                      .complete(function() { console.log("Loaded place frequencies") }); 











                        var view = "headline_by_city";
                        if (isNeighborhood)
                            view = "headline_by_neighborhood";
                        
                        if (window.currentView =="page1")
                            view += "_page_1";
                        else if (window.currentView == "today")
                            view += "_today"
                        var jqxhr =  $.getJSON(window.couchURL + 'boston-globe-articles/_design/globe/_view/'+view+'?key="'+name+'"', function() {
                
                        })
                       .success(function(json) {  
                              var printed = 0;
                             for (i=0; i<json.rows.length; i++) {
                                var headline = json.rows[i].value;

                                if (headline.headline != null)
                                {
                                  printed++;
                                  var text = headline.headline;
                                  if (headline.canonicalurl)
                                    text = '<a target="_blank" href="'+headline.canonicalurl+'">' + text + '</a>';
                                  if (i%2==0)
                                  {
                                    
                                    if (headline.printpagenumber == "1")
                                      $('#headlines').append("<p class='stripe page1'>" + text+"</p>");
                                    else
                                      $('#headlines').append("<p class='stripe'>" + text +"</p>");
                                  }
                                  else{
                                      if (headline.printpagenumber == "1")
                                        $('#headlines').append("<p class='page1'>" + text +"</p>"); 
                                      else 
                                        $('#headlines').append("<p>" + text +"</p>");
                                  }
                                }
                             }
                             if (json.rows.length ==0 || printed ==0)
                                $('#headlines').append("<p>No headlines available. Not all stories have a headline.</p>");
                             $('#headlines').addClass("scrolling");
                          })
                      .error(function(data) { console.log(data) })
                      .complete(function() { console.log("Loaded city & neighborhood headlines") }); 
                          
                  });
                  return townPolygon;

                }
                
                function loadTownPolygons(){
                  
                  var jqxhr =  $.getJSON('data/shapefiles/townsShapeFiles/MATowns.json', function() {
                      
                    })
                    .success(function(data) {   
                      window.townPolygons = {};
                      var polywindow = new google.maps.InfoWindow();
                      for (var i = 0; i < data.features.length; i++) {
                        var town = data.features[i];
                        var townName = town.properties.TOWN;
                        
                        var townPolygon = null;
                        if (townName != "Boston" && townName != "boston"){
                           //Handle multipolygons - what a pain!
                          if (town.geometry.type == "MultiPolygon"){
                             
                              var townPolygonArray = [];
                             
                             for (var j=0;j<town.geometry.coordinates.length;j++){
                                townPolygon = loadPolygon(town.geometry.coordinates[j][0], townName,false);
                                townPolygonArray[j] =townPolygon;
                             }
                              window.townPolygons[townName]=townPolygonArray;
                          } else {
                              townPolygon =loadPolygon(town.geometry.coordinates[0], townName,false);
                              window.townPolygons[townName]=townPolygon;
                          }
                        }
                      }
                    })
                    .error(function(data) { console.log(data) })
                    .complete(function() { console.log("Loaded MA Towns from GEOJSON...") });
                }
                function loadNeighborhoodPolygons(){
                  
                  var jqxhr =  $.getJSON('data/shapefiles/neighborhoodsShapeFiles/neighborhoods.json', function() {
                      
                    })
                    .success(function(data) {   
                      window.neighborhoodPolygons = {};
                      var polywindow = new google.maps.InfoWindow();
                      for (var i = 0; i < data.features.length; i++) {
                        var neighborhood = data.features[i];
                        var neighborhoodName = neighborhood.properties.name;
                        
                        var neighborhoodPolygon = null;
                         //Handle multipolygons - what a pain!
                        if (neighborhood.geometry.type == "MultiPolygon"){
                           
                            var neighborhoodPolygonArray = [];
                           
                           for (var j=0;j<neighborhood.geometry.coordinates.length;j++){
                              neighborhoodPolygon = loadPolygon(neighborhood.geometry.coordinates[j][0], neighborhoodName,true);
                              neighborhoodPolygonArray[j] =neighborhoodPolygon;
                           }
                            window.neighborhoodPolygons[neighborhoodName]=neighborhoodPolygonArray;
                        } else {
                            neighborhoodPolygon =loadPolygon(neighborhood.geometry.coordinates[0], neighborhoodName,true);
                            window.neighborhoodPolygons[neighborhoodName]=neighborhoodPolygon;
                        }
                      }
                    })
                    .error(function(data) { console.log(data) })
                    .complete(function() { console.log("Loaded Boston Neighborhoods from GEOJSON...") });
                }

            });
        </script>
        <script type="text/javascript">
        String.prototype.toProperCase = function () {
            return this.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
        };
        function addCommas(nStr)
        {
          nStr += '';
          x = nStr.split('.');
          x1 = x[0];
          x2 = x.length > 1 ? '.' + x[1] : '';
          var rgx = /(\d+)(\d{3})/;
          while (rgx.test(x1)) {
            x1 = x1.replace(rgx, '$1' + ',' + '$2');
          }
          return x1 + x2;
        };
        /* 
            Extension to Google Maps to get center of polygon 
            From here: http://code.google.com/p/google-maps-extensions/source/browse/google.maps.Polygon.getBounds.js
            May need this for drawing labels on the shapes


          if (!google.maps.Polygon.prototype.getBounds) {

                  google.maps.Polygon.prototype.getBounds = function(latLng) {

                          var bounds = new google.maps.LatLngBounds();
                          var paths = this.getPaths();
                          var path;
                          
                          for (var p = 0; p < paths.getLength(); p++) {
                                  path = paths.getAt(p);
                                  for (var i = 0; i < path.getLength(); i++) {
                                          bounds.extend(path.getAt(i));
                                  }
                          }

                          return bounds;
                  }

          }*/
        </script>
</html>